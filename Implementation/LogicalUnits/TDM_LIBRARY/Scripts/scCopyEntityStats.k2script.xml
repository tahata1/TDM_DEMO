<?xml version="1.0" encoding="utf-8"?>
<PhpScriptItem xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
  <Name>scCopyEntityStats</Name>
  <Code>/*$k2appDBParams = $k2ms-&gt;dbConnections['k2Proj'];
$k2appDBParams['dbUser'] = 'k2app';
$k2appDBParams['dbPass'] = 'k2app';        
$GLOBALS['dbLinks']['k2view'] = new db_postgresql($k2appDBParams);

$exeId = k2_getExecutionId();
$depId = k2_getProcessExecutionInfo();
$taskExecutionID = getGlobalValue("TDM_TASK_EXE_ID"); 
$environmentID = getGlobalValue("TDM_TAR_ENV_NAME");
/*$taskExecutionID = 1;
$environmentID = 2;
$exeId = '93';
$depId[2] = '186';
$eiTable = 'k2proj'.$exeId.'.k2ei_'.$exeId.'_'.$depId[2];
$tableName = DBSelectValue('k2view','SELECT table_name FROM information_schema.tables WHERE table_schema = $1 AND table_name = $2 limit 1', $params = array('k2proj'.$exeId, 'k2ei_'.$exeId.'_'.$depId[2]));
if (!empty($tableName) &amp; $tableName != null) {
	foreach (loopThroughDBSqlResult('k2view', 'SELECT * FROM '.$eiTable, SQL_FETCH_MODE_ASSOC) as $entityRow) {
		if (!isset($entityRow['execution_status']) || empty ($entityRow['execution_status']) || $entityRow['execution_status'] == null){
		    $entityRow['execution_status'] = 'stopped';
		}
        $params = array($taskExecutionID, $GLOBALS['logicalUnit'], $entityRow['entity_id'], $exeId, date('Y-m-d H:i:s'), $entityRow['entity_end_timestamp'], $entityRow['entity_start_timestamp'], $environmentID, $entityRow['execution_status'], 'ENTITY');
        DBExecute('TDM', "INSERT INTO TASK_EXECUTION_ENTITIES (task_execution_id, lu_name, entity_id, etl_execution_id, creation_date, entity_end_time, entity_start_time, env_id, execution_status, id_type) values($1,$2,$3,$4,$5,$6,$7,$8,$9,$10)", $params);
	}
}*/

$exeId = k2_getExecutionId();
$taskExecutionID = getGlobalValue("TDM_TASK_EXE_ID"); 
$environmentID = getGlobalValue("TDM_TAR_ENV_NAME");
$eiTable = getEntityInclusionTableName();


foreach (loopThroughDBSqlResult('k2Proj', 'SELECT entity_id,entity_end_timestamp,entity_start_timestamp,execution_status FROM '.$eiTable, SQL_FETCH_MODE_ASSOC) as $entityRow) {
                if (!isset($entityRow['execution_status']) || empty ($entityRow['execution_status']) || $entityRow['execution_status'] == null){
                    $entityRow['execution_status'] = 'stopped';
                };
	$iid=  substr($entityRow['entity_id'],strpos($entityRow['entity_id'],'_'));
	$target_entity_id = DBSelectValue('TDM', "select ENTITY_TARGET_ID from TDM_SEQ_MAPPING where TASK_EXECUTION_ID=".$taskExecutionID." and IS_INSTANCE_ID='Y' and SOURCE_ID=".$iid);
    $params = array($taskExecutionID, $GLOBALS['logicalUnit'], $entityRow['entity_id'],$target_entity_id, $exeId, date('Y-m-d H:i:s'), $entityRow['entity_end_timestamp'], $entityRow['entity_start_timestamp'], $environmentID, $entityRow['execution_status'], 'ENTITY');
    DBExecute('TDM', "INSERT INTO TASK_EXECUTION_ENTITIES (task_execution_id, lu_name, entity_id, target_entity_id, etl_execution_id, creation_date, entity_end_time, entity_start_time, env_id, execution_status, id_type) values($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11)", $params);
}
</Code>
  <IsSyntaxValid>true</IsSyntaxValid>
</PhpScriptItem>